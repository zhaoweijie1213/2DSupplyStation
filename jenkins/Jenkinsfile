/* groovylint-disable BlockStartsWithBlankLine, DuplicateMapLiteral, DuplicateNumberLiteral, DuplicateStringLiteral, LineLength, NoDef, VariableTypeRequired */
/* groovylint-disable-next-line CompileStatic */
properties([
    // [$class: 'GogsProjectProperty', gogsBranchFilter: 'test', gogsUsePayload: false] //åªæœ‰teståˆ†æ”¯å¯ç”¨webhook
])
pipeline {
    agent any
    environment {
        SERVICE_NAME = 'acg-supply-station' // å®šä¹‰æœåŠ¡åç§°å˜é‡
        DOCKERFILE_PATH = '2DSupplyStation.Host.Api/Dockerfile'  // âœ… æ¯ä¸ªé¡¹ç›®å¯é…ç½®
    }
    options {
        buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '15'))
    }
    parameters {
        // Git tag parameter for the master branch
        gitParameter(
            name: 'GIT_TAG',
            type: 'PT_TAG',
            defaultValue: 'v1.0.0',
            branchFilter: 'origin/master',
            sortMode: 'DESCENDING_SMART',
            tagFilter: 'v[0-9]*.[0-9]*.[0-9]', // âœ… æ­£å¼ç‰ˆæ ¼å¼ï¼švX.Y.Zï¼ˆä¸å« -devã€-beta ç­‰åç¼€ï¼‰
            description: 'é€‰æ‹©ç”¨äºæ„å»ºçš„æ­£å¼å‘å¸ƒ Git (master åˆ†æ”¯)'
        )

        // é master å’Œ develop åˆ†æ”¯æ—¶ä½¿ç”¨çš„é›†ç¾¤ç¯å¢ƒå‚æ•°
        choice(
            name: 'Cluster',
            choices: ['default', 'staging', 'production'], // æ ¹æ®ä½ çš„ç¯å¢ƒéœ€æ±‚æ·»åŠ é€‰é¡¹
            description: 'é€‰æ‹©éƒ¨ç½²çš„é›†ç¾¤ç¯å¢ƒ (é™¤ master å’Œ develop åˆ†æ”¯å¤–ä½¿ç”¨)'
        )
    }
    stages {
        // stage('æ‹‰å–æŒ‡å®š Git Tag') {
        //     when {
        //         branch 'master'
        //     }
        //     steps {
        //         checkout([
        //             $class: 'GitSCM',
        //             branches: [[name: "refs/tags/${params.GIT_TAG}"]],
        //             userRemoteConfigs: scm.userRemoteConfigs
        //         ])
        //         echo "âœ… å·² checkout åˆ° tag: ${params.GIT_TAG}"
        //     }
        // }
        stage('è®¾ç½®shè„šæœ¬çš„æ‰§è¡Œæƒé™') {
            steps {
                sh 'chmod +x ./jenkins/scripts/*.sh'
            }
        }
        stage('æ„å»ºDockeré•œåƒ') {
            steps {
                sh './jenkins/scripts/docker-image-build.sh'
                echo 'dockeré•œåƒæ„å»ºå®Œæˆ...'
                // è¯»å– build_meta.env ä¸­çš„ IMAGE_TAG
                script {
                    def props = readProperties file: './build_meta.env'
                    env.IMAGE_TAG = props['IMAGE_TAG']
                    echo "è¯»å–åˆ°é•œåƒæ ‡ç­¾: ${env.IMAGE_TAG}"
                }
            }
        }
        stage('å¼€å‘é˜¶æ®µ-éƒ¨ç½²åˆ°å†…ç½‘ç¯å¢ƒ') {
            when {
                branch 'master'
            }
            steps {
                script {
                    sh """
                        docker compose -p ${env.SERVICE_NAME} -f jenkins/docker-compose.yaml down || true
                        docker compose -p ${env.SERVICE_NAME} -f jenkins/docker-compose.yaml up -d
                        docker compose -p ${env.SERVICE_NAME} -f jenkins/docker-compose.yaml ps
                    """
                    sh "docker ps --filter name=${SERVICE_NAME}"
                }
            }
        }
    }
    // post {
    //     success {
    //         script {
    //             // def jobName = env.JOB_NAME
    //             // def baseJobName = jobName.split('/')[0]
    //             def updates = ''
    //             println('Collecting change sets...')

    //             currentBuild.changeSets.each { changeSet ->
    //                 changeSet.items.eachWithIndex { item, index ->
    //                     def updateMessage = "${index + 1}: ${item.msg}"
    //                     updates += updateMessage + '<br>'
    //                     println(updateMessage)
    //                 }
    //             }

    //             wrap([$class: 'BuildUser']) {
    //                 dingtalk(
    //                 robot: 'DingTalk-jenkins',
    //                 type: 'ACTION_CARD',
    //                 title: "[âœ…æˆåŠŸ] ${SERVICE_NAME} æ„å»ºæˆåŠŸ (#${env.BUILD_NUMBER})",
    //                 text: [
    //                     "### ğŸŸ¢ ${SERVICE_NAME} æ„å»ºæˆåŠŸ",
    //                     "- åˆ†æ”¯ï¼š**${GIT_BRANCH}**",
    //                     "- é•œåƒç‰ˆæœ¬ï¼š**${SERVICE_NAME}:${env.IMAGE_TAG}**",
    //                     "- æ„å»ºä»»åŠ¡ï¼š#${env.BUILD_NUMBER}",
    //                     "- æŒç»­æ—¶é—´ï¼š${currentBuild.durationString}",
    //                     "- æ‰§è¡Œäººï¼š${env.BUILD_USER}",
    //                     "- [æŸ¥çœ‹æ„å»ºè¯¦æƒ…](${env.BUILD_URL})",
    //                     "- æ›´æ–°å†…å®¹ï¼š<br>${updates ?: 'æ— æäº¤è®°å½•'}"
    //                 ]
    //             )
    //             }
    //         }
    //     }

    //     failure {
    //         script {
    //             // def jobName = env.JOB_NAME
    //             // def baseJobName = jobName.split('/')[0]
    //             def updates = ''
    //             println('Collecting change sets...')

    //             currentBuild.changeSets.each { changeSet ->
    //                 changeSet.items.eachWithIndex { item, index ->
    //                     def updateMessage = "${index + 1}: ${item.msg}"
    //                     updates += updateMessage + '<br>'
    //                     println(updateMessage)
    //                 }
    //             }

    //             wrap([$class: 'BuildUser']) {
    //                 dingtalk(
    //                 robot: 'DingTalk-jenkins',
    //                 type: 'ACTION_CARD',
    //                 title: "[âŒå¤±è´¥] ${SERVICE_NAME} æ„å»ºå¤±è´¥ (#${env.BUILD_NUMBER})",
    //                 text: [
    //                     "### ğŸ”´ ${SERVICE_NAME} æ„å»ºå¤±è´¥",
    //                     "- åˆ†æ”¯ï¼š**${GIT_BRANCH}**",
    //                     "- æ„å»ºä»»åŠ¡ï¼š#${env.BUILD_NUMBER}",
    //                     "- æŒç»­æ—¶é—´ï¼š${currentBuild.durationString}",
    //                     "- æ‰§è¡Œäººï¼š${env.BUILD_USER}",
    //                     "- [æŸ¥çœ‹æ„å»ºæ—¥å¿—](${env.BUILD_URL})",
    //                     "- æ›´æ–°å†…å®¹ï¼š<br>${updates ?: 'æ— æäº¤è®°å½•'}"
    //                 ]
    //             )
    //             }
    //         }
    //     }
    // }
}
